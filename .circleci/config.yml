version: 2
jobs: # step
  build: # as a entry point
    parallelism: 3
    docker:
      - image: circleci/ruby:2.6.5-node
        environment: # プライマリ コンテナの環境変数
          BUNDLE_JOBS: 3
          BUNDLE_RETRY: 3
          BUNDLE_PATH: vendor/bundle
          PGHOST: 127.0.0.1
          PGUSER: pposegres
          RAILS_ENV: test
      - image: circleci/postgres:13-alpine # データベース イメージ
        environment: # データベースの環境変数
          POSTGRES_USER: postgres
          POSTGRES_DB: docker_suggests_test
          POSTGRES_PASSWORD: ""
      #working_directory: ~/workspace/dic/dic-graduate-docker/dic_issue_graduate
    steps:
      - checkout
      # # Bundler のバージョンを指定
      # - run:
      #   　name: Bundler version
      #   　command: bundle -v

      #bundle キャッシュを復元
      - restore_cache:
        　keys: # リストされているキーの順番でキャッシュを復元
            - v1-dependencies-{{ checksum "Gemfile.lock" }}
            - v1-dependencies-

      # bundle install で依存関係をインストール
      - run:
        　name: install dependencies
        　command: |
          　gem install Bundler -v 2.1.4
          　bundle install --jobs=4 --retry=3 --path vendor/bundle
      # Ruby の依存関係のバンドル キャッシュを保存
      - save_cache:
        　key: v1-dependencies-{{ checksum "Gemfile.lock" }}
        　paths:
          　- ./vendor/bundle
      - run:
        　name: wait untill db up
        　command: dockerize -wait tcp://127.0.0.1:5432 -timeout 120s
      - run: bundle exec rake db:create
      - run: bundle exec rake db:schema:load

      - run:
        　name: run tests
        　command: bundle exec rspec
